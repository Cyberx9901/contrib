#!/bin/bash
# Script to offload building of a local PKGBUILD onto a remote server.
# After building, the resulting package is copied back to the local machine.
#
# Requirements:
# - You have to have keyless entry to the build server and it has to be running Arch Linux
#   with installed devtools.
# - rsync installed locally
#
# First argument is build tool to use (e.g. extra-x86_64-build).
# If not provided, defaults to extra-x86_64-build.

set -eo pipefail

BUILD_TOOL=${1-extra-x86_64-build}

# Which server to offload to.
SERVER=dragon.archlinux.org

# Where to put the source files.
BUILD_DIR=offloaded

if [[ ! -f PKGBUILD ]]; then
    echo "No PKGBUILD found in current dir, exiting"
    exit 1
fi

source /usr/share/makepkg/source.sh
source PKGBUILD

# Copy sources to offload server.
ssh $SERVER mkdir -pv offloaded/$pkgname
rsync -vh PKGBUILD $SERVER:$BUILD_DIR/$pkgname/PKGBUILD
[[ -n "$install" ]] && rsync -vh "$install" "$SERVER:$BUILD_DIR/$pkgname/$install"
sources_to_sync=()
for s in "${source[@]}"; do
    if [[ $(get_protocol $s) == "local" ]]; then
        sources_to_sync+=("$s")
    fi
done
[[ ${#sources_to_sync[@]} -ne 0 ]] && rsync -vh ${sources_to_sync[*]} "$SERVER:$BUILD_DIR/$pkgname/"
ssh -t $SERVER "cd $BUILD_DIR/$pkgname/ && makepkg --verifysource -f"

# Actually build the package
ssh -t $SERVER "cd $BUILD_DIR/$pkgname/ && $BUILD_TOOL"

# Copy back the built packages
resulting_packages=$(ssh $SERVER "cd $BUILD_DIR/$pkgname/ && makepkg --packagelist")
files_to_copy_back=""
for package in ${resulting_packages}; do
    files_to_copy_back="$files_to_copy_back $SERVER:$package"
done
[[ -n ${files_to_copy_back} ]] && rsync -vh ${files_to_copy_back[*]} .
